!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.MW={})}(this,function(t){"use strict";var R=void 0;function h(t,e,i,n){var o=void 0,r=void 0,s=void 0,a=void 0,h=(new THREE.Vector3).addVectors(n.max,n.min).multiplyScalar(.5),c=(new THREE.Vector3).subVectors(n.max,h),l=(new THREE.Vector3).subVectors(t,h),u=(new THREE.Vector3).subVectors(e,h),d=(new THREE.Vector3).subVectors(i,h),f=(new THREE.Vector3).subVectors(u,l),m=(new THREE.Vector3).subVectors(d,u),p=(new THREE.Vector3).subVectors(l,d),y=new THREE.Vector3(0,-f.z,f.y),v=new THREE.Vector3(0,-m.z,m.y),g=new THREE.Vector3(0,-p.z,p.y),b=new THREE.Vector3(f.z,0,-f.x),x=new THREE.Vector3(m.z,0,-m.x),w=new THREE.Vector3(p.z,0,-p.x),E=new THREE.Vector3(-f.y,f.x,0),M=new THREE.Vector3(-m.y,m.x,0),V=new THREE.Vector3(-p.y,p.x,0),o=l.dot(y),r=u.dot(y),s=d.dot(y),a=c.y*Math.abs(f.z)+c.z*Math.abs(f.y);if(Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=l.dot(v),r=u.dot(v),s=d.dot(v),a=c.y*Math.abs(m.z)+c.z*Math.abs(m.y),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=l.dot(g),r=u.dot(g),s=d.dot(g),a=c.y*Math.abs(p.z)+c.z*Math.abs(p.y),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=l.dot(b),r=u.dot(b),s=d.dot(b),a=c.x*Math.abs(f.z)+c.z*Math.abs(f.x),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=l.dot(x),r=u.dot(x),s=d.dot(x),a=c.x*Math.abs(m.z)+c.z*Math.abs(m.x),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=l.dot(w),r=u.dot(w),s=d.dot(w),a=c.x*Math.abs(p.z)+c.z*Math.abs(p.x),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=l.dot(E),r=u.dot(E),s=d.dot(E),a=c.x*Math.abs(f.y)+c.y*Math.abs(f.x),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=l.dot(M),r=u.dot(M),s=d.dot(M),a=c.x*Math.abs(m.y)+c.y*Math.abs(m.x),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(o=l.dot(V),r=u.dot(V),s=d.dot(V),a=c.x*Math.abs(p.y)+c.y*Math.abs(p.x),Math.max(-Math.max(o,r,s),Math.min(o,r,s))>a)return!1;if(Math.max(l.x,u.x,d.x)<-c.x||Math.min(l.x,u.x,d.x)>c.x)return!1;if(Math.max(l.y,u.y,d.y)<-c.y||Math.min(l.y,u.y,d.y)>c.y)return!1;if(Math.max(l.z,u.z,d.z)<-c.z||Math.min(l.z,u.z,d.z)>c.z)return!1;var k,R,P,z,_,S,T=new THREE.Plane;return T.normal=(new THREE.Vector3).copy(m).cross(f).normalize(),T.constant=T.normal.dot(t),k=n,R=T,P=(new THREE.Vector3).addVectors(k.max,k.min).multiplyScalar(.5),z=(new THREE.Vector3).subVectors(k.max,P),_=z.x*Math.abs(R.normal.x)+z.y*Math.abs(R.normal.y)+z.z*Math.abs(R.normal.z),S=R.normal.dot(P)-R.constant,Math.abs(S)<=_}function l(t,e){var i=0;return t.center.x<e.min.x&&(i+=(e.min.x-t.center.x)*(e.min.x-t.center.x)),t.center.x>e.max.x&&(i+=(t.center.x-e.max.x)*(t.center.x-e.max.x)),t.center.y<e.min.y&&(i+=(e.min.y-t.center.y)*(e.min.y-t.center.y)),t.center.y>e.max.y&&(i+=(t.center.y-e.max.y)*(t.center.y-e.max.y)),t.center.z<e.min.z&&(i+=(e.min.z-t.center.z)*(e.min.z-t.center.z)),t.center.z>e.max.z&&(i+=(t.center.z-e.max.z)*(t.center.z-e.max.z)),i<=t.radius*t.radius}var e=function(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t};function n(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function p(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var u=(e(y,[{key:"importThreeMesh",value:function(t){t.updateMatrix();var e=t.geometry.uuid,i=t.geometry.clone();if(i.applyMatrix(t.matrix),i.computeVertexNormals(),i instanceof R.BufferGeometry){if(void 0!==i.index)for(var n=i.index.array,o=i.attributes.position.array,r=0!==i.groups.length?i.groups:[{start:0,count:n.length,index:0}],s=0,a=r.length;s<a;++s)for(var h=r[s].start,c=r[s].count,l=r[s].materialIndex,u=h,d=h+c;u<d;u+=3){var f=l+n[u],m=l+n[u+1],p=l+n[u+2],y=(new R.Vector3).fromArray(o,3*f),v=(new R.Vector3).fromArray(o,3*m),g=(new R.Vector3).fromArray(o,3*p),b=(new R.Vector3).subVectors(g,v),x=(new R.Vector3).subVectors(y,v),w=b.cross(x).normalize().clone(),E=new P(y,v,g,w,e);this.addFace(E)}}else{i.computeFaceNormals();for(var M=0,V=i.faces.length;M<V;M++){var k=new P(i.vertices[i.faces[M].a],i.vertices[i.faces[M].b],i.vertices[i.faces[M].c],i.faces[M].normal,e);this.addFace(k)}}}},{key:"addFace",value:function(t){for(var e=[],i=this.nodes[0].slice(0),n=0,o=this.maxDepth;n<o;n++){for(var r=0,s=i.length;r<s;r++){var a=i[r];h(t.a,t.b,t.c,a)&&(a.trianglePool.push(t),n+1!==this.maxDepth&&(e=e.concat(a.getChildNodes())))}if(0===e.length)break;i=e.slice(0),e.length=0}}},{key:"removeThreeMesh",value:function(i){this.nodes.forEach(function(t){t.forEach(function(t){var e=[];t.trianglePool.forEach(function(t){t.meshID!==i&&e.push(t)}),t.trianglePool=e})})}},{key:"getIntersectedNodes",value:function(t,e){var i=[],n=[];if(!l(t,this))return[];for(var o=this.nodes[0].slice(0),r=0,s=e;r<s;r++){for(var a=0,h=o.length;a<h;a++){var c=o[a];l(t,c)&&(r+1===e?0!==c.trianglePool.length&&n.push(c):i=i.concat(c.getChildNodes()))}o=i.slice(0),i.length=0}return n}}]),y);function y(t,e,i){p(this,y),this.min=t,this.max=e,this.maxDepth=i,this.nodes=[],this.isOctree=!0;for(var n=new R.Vector3,o=new R.Vector3,r=new R.Vector3,s=0;s<this.maxDepth;s++){this.nodes.push([]);var a=Math.pow(2,s),h=Math.pow(4,s);n.subVectors(this.max,this.min).divideScalar(a);for(var c=0,l=Math.pow(8,s);c<l;c++){var u=c%a,d=c/h|0,f=(c/a|0)%a;o.set(this.min.x+u*n.x,this.min.y+d*n.y,this.min.z+f*n.z),r.copy(o).add(n);var m=y.getMortonNumber(u,d,f);this.nodes[s][m]=new v(this,s,m,o,r)}}}u.separate3Bit=function(t){return t=2396745&((t=798915&((t=61455&(t|t<<8))|t<<4))|t<<2)},u.getMortonNumber=function(t,e,i){return u.separate3Bit(t)|u.separate3Bit(e)<<1|u.separate3Bit(i)<<2},u.uniqTriangkesfromNodes=function(t){var e=[],i=!1;if(0===t.length)return[];if(1===t.length)return t[0].trianglePool.slice(0);for(var n=0,o=t.length;n<o;n++)for(var r=0,s=t[n].trianglePool.length;r<s;r++){for(var a=0,h=e.length;a<h;a++)t[n].trianglePool[r]===e[a]&&(i=!0);i||e.push(t[n].trianglePool[r]),i=!1}return e};var v=(e(r,[{key:"getParentNode",value:function(){if(0===this.depth)return null;this.tree.nodes[this.depth][this.mortonNumber>>3]}},{key:"getChildNodes",value:function(){if(this.tree.maxDepth===this.depth)return null;var t=this.mortonNumber<<3;return[this.tree.nodes[this.depth+1][t],this.tree.nodes[this.depth+1][1+t],this.tree.nodes[this.depth+1][2+t],this.tree.nodes[this.depth+1][3+t],this.tree.nodes[this.depth+1][4+t],this.tree.nodes[this.depth+1][5+t],this.tree.nodes[this.depth+1][6+t],this.tree.nodes[this.depth+1][7+t]]}}]),r);function r(t,e,i,n,o){p(this,r),this.tree=t,this.depth=e,this.mortonNumber=i,this.min=new R.Vector3(n.x,n.y,n.z),this.max=new R.Vector3(o.x,o.y,o.z),this.trianglePool=[]}var P=function t(e,i,n,o,r){p(this,t),this.a=e.clone(),this.b=i.clone(),this.c=n.clone(),this.normal=o.clone(),this.meshID=r};function o(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var i=(function(t,e,i){return e&&o(t.prototype,e),i&&o(t,i),t}(s,[{key:"add",value:function(t){t.isOctree?this.colliderPool.push(t):t.isCharacterController&&(this.characterPool.push(t),t.world=this)}},{key:"step",value:function(t){for(var e=0,i=this.characterPool.length;e<i;e++){for(var n=this.characterPool[e],o=void 0,r=0,s=this.colliderPool.length;r<s;r++)var a=this.colliderPool[r],h=new R.Sphere(n.center,n.radius+n.groundPadding),c=a.getIntersectedNodes(h,a.maxDepth),o=u.uniqTriangkesfromNodes(c);n.collisionCandidate=o,n.update(t)}}}]),s);function s(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,s),this.colliderPool=[],this.characterPool=[]}var a=function(t,e,i){return e&&c(t.prototype,e),i&&c(t,i),t};function c(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}function m(t,e){return(t%e+e)%e}var g=2*Math.PI,d=(a(f,[{key:"play",value:function(t){var e,i;this.currentMotionName!==t&&(this.motion[this.currentMotionName]?(e=this.motion[this.currentMotionName].play(),i=this.motion[t].play(),e.enabled=!0,i.enabled=!0,e.crossFadeTo(i,.3)):(this.motion[t].enabled=!0,this.motion[t].play()),this.currentMotionName=t)}},{key:"turn",value:function(t,e){var i,n,o,r,s,a=this,h=this.mesh.rotation.y,c=t,l=(o=m((i=h)-(n=c),g),r=m(n-i,g),o<r?-o:r),u=Date.now(),d=u+200,f=0;e?this.mesh.rotation.y=c:this._targetRotY!==c&&(s=this._targetRotY=c,function t(){var e=Date.now();if(s===a._targetRotY){if(d<=e)return a.mesh.rotation.y=s,void delete a._targetRotY;requestAnimationFrame(t),f=(e-u)/200,a.mesh.rotation.y=h+l*f}}())}},{key:"update",value:function(t){this.mixer.update(t)}}]),f);function f(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,f),this.mesh=t,this.motion={},this.mixer=new THREE.AnimationMixer(t),this.currentMotionName="";for(var e=0,i=this.mesh.geometry.animations.length;e<i;e++){var n=this.mesh.geometry.animations[e];this.motion[n.name]=this.mixer.clipAction(n),this.motion[n.name].setEffectiveWeight(1)}}function b(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var x=(function(t,e,i){return e&&b(t.prototype,e),i&&b(t,i),t}(w,[{key:"addEventListener",value:function(t,e){var i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}},{key:"hasEventListener",value:function(t,e){var i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)}},{key:"removeEventListener",value:function(t,e){var i,n=this._listeners[t];void 0===n||-1!==(i=n.indexOf(e))&&n.splice(i,1)}},{key:"dispatchEvent",value:function(t){var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=e.slice(0),n=0,o=i.length;n<o;n++)i[n].call(this,t)}}}]),w);function w(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,w),this._listeners={}}var E=function(t,e,i){return e&&M(t.prototype,e),i&&M(t,i),t};function M(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var V=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(k,x),E(k,[{key:"update",value:function(t){this.isGrounded=!1,this.isOnSlope=!1,this.groundHeight=-1/0,this.groundNormal.set(0,1,0),this.updateGrounding(),this.updateJumping(),this.updatePosition(t),this.collisionDetection(),this.solvePosition(),this.updateVelocity(),this.events()}},{key:"updateVelocity",value:function(){var t,e=-Math.cos(this.direction),i=-Math.sin(this.direction),n=!1;if(this.velocity.set(i*this.movementSpeed*this.isRunning,-20,e*this.movementSpeed*this.isRunning),0!==this.contactInfo.length||this.isJumping){!this.isGrounded||this.isOnSlope||this.isJumping?this.isOnSlope?(t=20/(1-this.groundNormal.y)*.2,this.velocity.x=this.groundNormal.x*t,this.velocity.y=-20,this.velocity.z=this.groundNormal.z*t):this.isGrounded||this.isOnSlope||!this.isJumping||(this.velocity.y=20*this.currentJumpPower):this.velocity.y=0;for(var o=new R.Vector2(i,e),r=Math.atan2(-o.y,-o.x),s=0,a=this.contactInfo.length;s<a;s++){var h,c,l=this.contactInfo[s].face.normal;this.maxSlopeGradient<l.y||this.isOnSlope||(!n&&l.y<0&&(n=!0),h=new R.Vector2(l.x,l.z).normalize(),c=Math.atan2(h.y,h.x),Math.abs(r-c)>=.5*Math.PI&&Math.abs(r-c)<=1.5*Math.PI||(h.set(o.dot(h)*h.x,o.dot(h)*h.y),o.sub(h),this.velocity.x=o.x*this.movementSpeed*this.isRunning,this.velocity.z=o.y*this.movementSpeed*this.isRunning))}n&&(this.velocity.y=Math.min(0,this.velocity.y),this.isJumping=!1)}}},{key:"updateGrounding",value:function(){for(var t=void 0,e=void 0,i=this.collisionCandidate,n=new R.Vector3(this.center.x,this.center.y+this.radius,this.center.z),o=new R.Vector3(this.center.x,this.center.y-1e10,this.center.z),r=0,s=i.length;r<s;r++)((e=function(t,e,i,n,o){var r=n.clone().sub(i),s=o.clone().sub(i),a=t.clone().sub(e),h=r.clone().cross(s),c=a.dot(h);if(c<=0)return!1;var l=t.clone().sub(i),u=l.dot(h);if(u<0)return 0;if(c<u)return 0;var d=a.clone().cross(l),f=s.dot(d);if(f<0||c<f)return 0;var m=-1*r.clone().dot(d);if(m<0||c<f+m)return 0;var p=1/c;u*=p;var y=1-(f*=p)-(m*=p),v=i.clone().multiplyScalar(y),g=n.clone().multiplyScalar(f),b=o.clone().multiplyScalar(m);return{contactPoint:v.clone().add(g).add(b)}}(n,o,i[r].a,i[r].b,i[r].c))&&!t||e&&e.contactPoint.y>t.contactPoint.y)&&((t=e).face=i[r]);if(t){this.groundHeight=t.contactPoint.y,this.groundNormal.copy(t.face.normal);var a=n.y,h=this.center.y-this.radius-this.groundPadding;if(this.isJumping&&0<this.currentJumpPower)return this.isOnSlope=!1,void(this.isGrounded=!1);this.isGrounded=h<=this.groundHeight&&this.groundHeight<=a,this.isOnSlope=this.groundNormal.y<=this.maxSlopeGradient,this.isGrounded&&(this.isJumping=!1)}}},{key:"updatePosition",value:function(t){var e=this.groundHeight+this.radius,i=this.center.x+this.velocity.x*t,n=this.center.y+this.velocity.y*t,o=this.center.z+this.velocity.z*t;this.center.set(i,this.isGrounded?e:n,o)}},{key:"collisionDetection",value:function(){for(var t=this.collisionCandidate,e=this.contactInfo.length=0,i=t.length;e<i;e++){var n=function(t,e,i,n,o){var r=(new THREE.Vector3).subVectors(e,t.center),s=(new THREE.Vector3).subVectors(i,t.center),a=(new THREE.Vector3).subVectors(n,t.center),h=t.radius*t.radius,c=(new THREE.Vector3).crossVectors(s.clone().sub(r),a.clone().sub(r)),l=r.dot(c),u=c.dot(c);if(h*u<l*l)return!1;var d=r.dot(r),f=r.dot(s),m=r.dot(a),p=s.dot(s),y=s.dot(a),v=a.dot(a);if(h<d&d<f&d<m||h<p&p<f&p<y||h<v&v<m&v<y)return!1;var g=(new THREE.Vector3).subVectors(s,r),b=(new THREE.Vector3).subVectors(a,s),x=(new THREE.Vector3).subVectors(r,a),w=f-d,E=y-p,M=m-v,V=g.dot(g),k=b.dot(b),R=x.dot(x),P=(new THREE.Vector3).subVectors(r.multiplyScalar(V),g.multiplyScalar(w)),z=(new THREE.Vector3).subVectors(s.multiplyScalar(k),b.multiplyScalar(E)),_=(new THREE.Vector3).subVectors(a.multiplyScalar(R),x.multiplyScalar(M)),S=(new THREE.Vector3).subVectors(a.multiplyScalar(V),P),T=(new THREE.Vector3).subVectors(r.multiplyScalar(k),z),O=(new THREE.Vector3).subVectors(s.multiplyScalar(R),_);if(P.dot(P)>h*V*V&&0<=P.dot(S)||z.dot(z)>h*k*k&&0<=z.dot(T)||_.dot(_)>h*R*R&&0<=_.dot(O))return!1;var H=Math.sqrt(l*l/u)-t.radius-1,L=new THREE.Vector3(-o.x,-o.y,-o.z);return{distance:H,contactPoint:t.center.clone().add(L.multiplyScalar(H))}}(this,t[e].a,t[e].b,t[e].c,t[e].normal);n&&(n.face=t[e],this.contactInfo.push(n))}}},{key:"solvePosition",value:function(){var t=void 0,e=void 0,i=new R.Vector3,n=new R.Vector3,o=new R.Vector3,r=new R.Vector3,s=new R.Vector3;if(0!==this.contactInfo.length){for(var a=0,h=this.contactInfo.length;a<h;a++){var c,l,t=this.contactInfo[a].face,e=this.contactInfo[a].face.normal;this.maxSlopeGradient<e.y||(c=this.maxSlopeGradient<=t.normal.y&&t.normal.y<1,this.isJumping&&this.currentJumpPower<=0&&c&&(this.isJumping=!1,this.isGrounded=!0),(this.isGrounded||this.isOnSlope)&&(i.copy(e).multiplyScalar(-this.radius).add(this.center),o.set(e.x,0,e.z).normalize(),l=(t.a.dot(e)-(e.x*i.x+e.y*i.y+e.z*i.z))/(e.x*o.x+e.y*o.y+e.z*o.z),n.copy(o).multiplyScalar(l).add(i),r.subVectors(n,i),Math.abs(s.x)>Math.abs(r.x)&&(s.x+=r.x),Math.abs(s.z)>Math.abs(r.z)&&(s.z+=r.z)))}this.center.add(s),this.object.position.copy(this.center)}else this.object.position.copy(this.center)}},{key:"setDirection",value:function(){}},{key:"jump",value:function(){this.isJumping||!this.isGrounded||this.isOnSlope||(this.jumpStartTime=Date.now(),this.currentJumpPower=1,this.isJumping=!0)}},{key:"updateJumping",value:function(){var t;this.isJumping&&(t=(Date.now()-this.jumpStartTime)/1e3,this.currentJumpPower=Math.cos(Math.min(t,1)*Math.PI))}}]),k);function k(t,e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,k);var i=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(k.__proto__||Object.getPrototypeOf(k)).call(this));i.isCharacterController=!0,i.object=t,i.center=i.object.position.clone(),i.radius=e,i.groundPadding=.5,i.maxSlopeGradient=Math.cos(50*R.Math.DEG2RAD),i.isGrounded=!1,i.isOnSlope=!1,i.isIdling=!1,i.isRunning=!1,i.isJumping=!1,i.direction=0,i.movementSpeed=10,i.velocity=new R.Vector3(0,-10,0),i.currentJumpPower=0,i.jumpStartTime=0,i.groundHeight=0,i.groundNormal=new R.Vector3,i.collisionCandidate,i.contactInfo=[];var n=!0,o=void 0,r=void 0,s=void 0,a=void 0;return i.events=function(){if(n)return n=!1,o=i.isGrounded,r=i.isOnSlope,i.isIdling,s=i.isRunning,void(a=i.isJumping);s||i.isRunning||!i.isGrounded||i.isIdling?!s&&i.isRunning&&!i.isJumping&&i.isGrounded||!o&&i.isGrounded&&i.isRunning||r&&!i.isOnSlope&&i.isRunning&&i.isGrounded?(i.isIdling=!1,i.dispatchEvent({type:"startWalking"})):!a&&i.isJumping?(i.isIdling=!1,i.dispatchEvent({type:"startJumping"})):!r&&i.isOnSlope?i.dispatchEvent({type:"startSliding"}):!o||i.isGrounded||i.isJumping||i.dispatchEvent({type:"startFalling"}):(i.isIdling=!0,i.dispatchEvent({type:"startIdling"})),o||i.isGrounded,o=i.isGrounded,r=i.isOnSlope,i.isIdling,s=i.isRunning,a=i.isJumping},i}var z=function(t,e,i){return e&&_(t.prototype,e),i&&_(t,i),t};function _(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var S=87,T=38,O=83,H=40,L=65,j=37,D=68,C=39,A=32,I=Math.PI/180,G=0*I,N=45*I,J=90*I,Y=135*I,W=180*I,F=225*I,K=270*I,U=315*I,X=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(B,x),z(B,[{key:"jump",value:function(){this.dispatchEvent({type:"jumpkeypress"})}},{key:"updateAngle",value:function(){var t=this.isUp,e=this.isDown,i=this.isLeft,n=this.isRight;!t||i||e||n?t&&i&&!e&&!n?this.frontAngle=N:t||!i||e||n?!t&&i&&e&&!n?this.frontAngle=Y:t||i||!e||n?!t&&!i&&e&&n?this.frontAngle=F:t||i||e||!n?t&&!i&&!e&&n&&(this.frontAngle=U):this.frontAngle=K:this.frontAngle=W:this.frontAngle=J:this.frontAngle=G}}]),B);function B(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,B);var t=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(B.__proto__||Object.getPrototypeOf(B)).call(this));return t.isDisabled=!1,t.isUp=!1,t.isDown=!1,t.isLeft=!1,t.isRight=!1,t.isMoveKeyHolded=!1,t.frontAngle=0,t._keydownListener=function(t){if(this.isDisabled)return;switch(t.keyCode){case S:case T:this.isUp=!0;break;case O:case H:this.isDown=!0;break;case L:case j:this.isLeft=!0;break;case D:case C:this.isRight=!0;break;case A:this.jump();break;default:return}var e=this.frontAngle;this.updateAngle(),e!==this.frontAngle&&this.dispatchEvent({type:"movekeychange"});(this.isUp||this.isDown||this.isLeft||this.isRight)&&!this.isMoveKeyHolded&&(this.isMoveKeyHolded=!0,this.dispatchEvent({type:"movekeyon"}))}.bind(t),t._keyupListener=function(t){if(this.isDisabled)return;switch(t.keyCode){case S:case T:this.isUp=!1;break;case O:case H:this.isDown=!1;break;case L:case j:this.isLeft=!1;break;case D:case C:this.isRight=!1;break;case A:break;default:return}var e=this.frontAngle;this.updateAngle(),e!==this.frontAngle&&this.dispatchEvent({type:"movekeychange"});this.isUp||this.isDown||this.isLeft||this.isRight||t.keyCode!==S&&t.keyCode!==T&&t.keyCode!==O&&t.keyCode!==H&&t.keyCode!==L&&t.keyCode!==j&&t.keyCode!==D&&t.keyCode!==C||(this.isMoveKeyHolded=!1,this.dispatchEvent({type:"movekeyoff"}))}.bind(t),t._blurListener=function(){this.isUp=!1,this.isDown=!1,this.isLeft=!1,this.isRight=!1,this.isMoveKeyHolded&&(this.isMoveKeyHolded=!1,this.dispatchEvent({type:"movekeyoff"}))}.bind(t),window.addEventListener("keydown",t._keydownListener),window.addEventListener("keyup",t._keyupListener),window.addEventListener("blur",t._blurListener),t}var q=function(t,e,i){return e&&Q(t.prototype,e),i&&Q(t,i),t};function Q(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var Z=2*Math.PI,$=Math.PI/2,tt=new R.Matrix4,et=new R.Matrix4,it=new R.Matrix4,nt=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(ot,x),q(ot,[{key:"update",value:function(){this._center=new R.Vector3(this.trackObject.matrixWorld.elements[12]+this.offset.x,this.trackObject.matrixWorld.elements[13]+this.offset.y,this.trackObject.matrixWorld.elements[14]+this.offset.z);var t=new R.Vector3(Math.cos(this.phi)*Math.cos(this.theta+$),Math.sin(this.phi),Math.cos(this.phi)*Math.sin(this.theta+$)),e=this.collisionTest(t.clone().normalize());t.multiplyScalar(e),t.add(this._center),this.camera.position.copy(t),90===this.lat?this.camera.up.set(Math.cos(this.theta+Math.PI),0,Math.sin(this.theta+Math.PI)):-90===this.lat?this.camera.up.set(Math.cos(this.theta),0,Math.sin(this.theta)):this.camera.up.set(0,1,0),this.camera.lookAt(this._center),this.dispatchEvent({type:"updated"})}},{key:"getFrontAngle",value:function(){return Z+this.theta}},{key:"setNearPlainCornersWithPadding",value:function(){var t=this.camera.near,e=.5*this.camera.fov,i=Math.tan(e*R.Math.DEG2RAD)*t,n=i*this.camera.aspect;this.nearPlainCornersWithPadding=[new R.Vector3(-n-t,-i-t,0),new R.Vector3(n+t,-i-t,0),new R.Vector3(n+t,i+t,0),new R.Vector3(-n-t,i+t,0)]}},{key:"setLatLon",value:function(t,e){this.lat=90<t?90:t<-90?-90:t,this.lon=e<0?360+e%360:e%360,this.phi=this.lat*R.Math.DEG2RAD,this.theta=-this.lon*R.Math.DEG2RAD}},{key:"collisionTest",value:function(t){var e=this.radius;et.makeRotationX(this.phi),it.makeRotationY(this.theta),tt.multiplyMatrices(et,it);for(var i=0;i<4;i++){var n=this.nearPlainCornersWithPadding[i].clone();n.applyMatrix4(tt);var o=new R.Vector3(this._center.x+n.x,this._center.y+n.y,this._center.z+n.z),r=new R.Raycaster(o,t,this.camera.near,this.radius).intersectObjects(this.rigidObjects);0!==r.length&&r[0].distance<e&&(e=r[0].distance)}return e}}]),ot);function ot(t,e){var i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,ot);var n=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(ot.__proto__||Object.getPrototypeOf(ot)).call(this));return n.camera=t,n.trackObject=e,n.el=i.el||document.body,n.offset=i.offset||new R.Vector3(0,0,0),n.radius=i.radius||10,n.minRadius=i.minRadius||1,n.maxRadius=i.maxRadius||30,n.rigidObjects=i.rigidObjects||[],n.lat=0,n.lon=0,n.phi=0,n.theta=0,n.mouseAccelerationX=void 0!==i.mouseAccelerationX?i.mouseAccelerationX:100,n.mouseAccelerationY=void 0!==i.mouseAccelerationY?i.mouseAccelerationY:30,n._pointerStart={x:0,y:0},n._pointerLast={x:0,y:0},n.setNearPlainCornersWithPadding(),n.update(),n._mousedownListener=function(t){this.dispatchEvent({type:"mousedown"}),this._pointerStart.x=t.clientX,this._pointerStart.y=t.clientY,this._pointerLast.x=this.lon,this._pointerLast.y=this.lat,this.el.removeEventListener("mousemove",this._mousedragListener,!1),this.el.addEventListener("mousemove",this._mousedragListener,!1),document.body.classList.add("js-TPSCameraDragging")}.bind(n),n._mouseupListener=function(){this.dispatchEvent({type:"mouseup"}),this.el.removeEventListener("mousemove",this._mousedragListener,!1),document.body.classList.remove("js-TPSCameraDragging")}.bind(n),n._mousedragListener=function(t){var e=this.el.offsetWidth,i=this.el.offsetHeight,n=(this._pointerStart.x-t.clientX)/e*2,o=(this._pointerStart.y-t.clientY)/i*2;this.setLatLon(this._pointerLast.y+o*this.mouseAccelerationY,this._pointerLast.x+n*this.mouseAccelerationX)}.bind(n),n._scrollListener=function(t){t.preventDefault(),t.wheelDeltaY?this.radius-=.05*t.wheelDeltaY/5:t.wheelDelta?this.radius-=.05*t.wheelDelta/5:t.detail&&(this.radius+=t.detail/5);this.radius=Math.max(this.radius,this.minRadius),this.radius=Math.min(this.radius,this.maxRadius)}.bind(n),n.el.addEventListener("mousedown",n._mousedownListener),n.el.addEventListener("mouseup",n._mouseupListener),n.el.addEventListener("mousewheel",n._scrollListener),n.el.addEventListener("DOMMouseScroll",n._scrollListener),n}t.install=function(t){R&&t===R?"production"!==process.env.NODE_ENV&&console.error("[THREE] already installed. `install` should be called only once."):R=t},t.World=i,t.Octree=u,t.AnimationController=d,t.CharacterController=V,t.KeyInputControl=X,t.TPSCameraControl=nt,Object.defineProperty(t,"__esModule",{value:!0})});
